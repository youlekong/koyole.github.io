<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="google-site-verification" content="v24WJQb0ZRnWSW9oNk49JVDx9SXCmZj3nOSAHggz1hM" />
  <meta name="description" content="javascript | HTML5 | CSS3 | PHP | React | Vue">
  <meta name="keywords" content="javascript, HTML5, CSS3, PHP, React, Vue">
  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <title>YOLE</title>
  <style>
    html, body {
        color: #000;
        font-family: "Times New Roman", Times, serif;
    }
  </style>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/highlight.css">
</head>
  <body>
    <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">YOLE</a>
    <span class="subtitle">424188487@qq.com</span>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/archives" class="menu-item-link">Archives</a>
        </li>
      
        <li class="menu-item">
          <a href="https://github.com/youlekong" class="menu-item-link">Github</a>
        </li>
      
    </ul>
  </nav>
</header>
    <main class="main">
      <article class="post">
  <div class="post-title">
    <h2 class="title">Cordova_ios</h2>
  </div>
  <div class="post-meta">
    <span class="post-time">2016-07-04</span>
  </div>
  <div class="post-content">
    <p>选择<a href="http://cordova.apache.org/" target="_blank" rel="external">Cordova</a>开发Hybrid App。除此之外还有其他方式，如：<a href="http://reactnative.cn/" target="_blank" rel="external">React Native</a>, <a href="http://cn.vuejs.org/" target="_blank" rel="external">Vue.js</a>等。</p>
<a id="more"></a>
<h3 id="一-项目集成"><a href="#一-项目集成" class="headerlink" title="一.项目集成"></a>一.项目集成</h3><ul>
<li>官网提供：NPM(Nodejs的包管理工具，node package manager)方式集成<ul>
<li>$ npm install -g cordova #若全局安装失败，则进入项目目录执行$ npm install cordova</li>
<li>$ cordova create <path></path></li>
<li>$ cd MyApp</li>
<li>$ cordova platform add <platform name=""> #cordova platform查看支持平台，这里选ios</platform></li>
</ul>
</li>
<li>cocoapods：cocoapods(Ruby开发的iOS库管理工具)<ul>
<li>$ cd <path></path></li>
<li>$ pod init # 生成Podfile文件</li>
<li>$ vi Podfile # 添加 <strong>pod ‘Cordova’, ‘~&gt; 3.6’</strong></li>
</ul>
</li>
</ul>
<h3 id="二-Cordova工作原理-github"><a href="#二-Cordova工作原理-github" class="headerlink" title="二.Cordova工作原理 github"></a>二.Cordova工作原理 <small><a href="https://github.com/apache/cordova-ios" target="_blank" rel="external">github</a></small></h3><h6 id="1-交互流程"><a href="#1-交互流程" class="headerlink" title="1.交互流程"></a>1.交互流程</h6><ul>
<li><event>js方法：Cordova.exec(successCallback, failCallback, service, action, actionArgs) </event></li>
</ul>
<ol>
<li>cordova.js内部方法:iOSExec() </li>
<li>webView方法：shouldStartLoadWithRequest:: </li>
<li>cordova方法：FetchCommonsFromJS </li>
<li>cordova plugin</li>
<li>do sth</li>
<li>cordova: sendPlugin </li>
<li>oc: StringByEvalutingJavascriptFromString</li>
</ol>
<h6 id="2-源码"><a href="#2-源码" class="headerlink" title="2.源码"></a>2.源码</h6><p><a href="https://github.com/apache/cordova-ios/blob/master/CordovaLib/cordova.js" target="_blank" rel="external">cordova.js</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">iOSExec</span>(<span class="params"></span>) </span>&#123;</div><div class="line"> </div><div class="line">    <span class="comment">// 定义变量接受传入的参数，其中</span></div><div class="line">    <span class="comment">// successCallback, failCallback:成功失败的回调</span></div><div class="line">    <span class="comment">// service:iOS native的plugin名</span></div><div class="line">    <span class="comment">// action:plugin中的方法名</span></div><div class="line">    <span class="comment">// actionArgs: 方法参数</span></div><div class="line">    <span class="keyword">var</span> successCallback, failCallback, service, action, actionArgs;  </div><div class="line">    <span class="comment">// callbackId: 作为key，映射回调方法</span></div><div class="line">    <span class="keyword">var</span> callbackId = <span class="literal">null</span>;</div><div class="line">    <span class="comment">// js中arguments为方法隐式方法，数据结构类数组</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">arguments</span>[<span class="number">0</span>] !== <span class="string">'string'</span>) &#123;</div><div class="line">        <span class="comment">// FORMAT ONE</span></div><div class="line">        successCallback = <span class="built_in">arguments</span>[<span class="number">0</span>];</div><div class="line">        failCallback = <span class="built_in">arguments</span>[<span class="number">1</span>];</div><div class="line">        service = <span class="built_in">arguments</span>[<span class="number">2</span>];</div><div class="line">        action = <span class="built_in">arguments</span>[<span class="number">3</span>];</div><div class="line">        actionArgs = <span class="built_in">arguments</span>[<span class="number">4</span>];</div><div class="line"></div><div class="line">        <span class="comment">// Since we need to maintain backwards compatibility, we have to pass</span></div><div class="line">        <span class="comment">// an invalid callbackId even if no callback was provided since plugins</span></div><div class="line">        <span class="comment">// will be expecting it. The Cordova.exec() implementation allocates</span></div><div class="line">        <span class="comment">// an invalid callbackId and passes it even if no callbacks were given.</span></div><div class="line">        callbackId = <span class="string">'INVALID'</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'The old format of this exec call has been removed (deprecated since 2.1). Change to: '</span> +</div><div class="line">            <span class="string">'cordova.exec(null, null, \\'</span>Service\\<span class="string">', \\'</span>action\\<span class="string">', [ arg1, arg2 ]);'</span></div><div class="line">        );</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// If actionArgs is not provided, default to an empty array</span></div><div class="line">    actionArgs = actionArgs || [];</div><div class="line"></div><div class="line">    <span class="comment">// Register the callbacks and add the callbackId to the positional</span></div><div class="line">    <span class="comment">// arguments if given.</span></div><div class="line">    <span class="keyword">if</span> (successCallback || failCallback) &#123;</div><div class="line">        callbackId = service + cordova.callbackId++;</div><div class="line">        cordova.callbacks[callbackId] =</div><div class="line">            &#123;<span class="attr">success</span>:successCallback, <span class="attr">fail</span>:failCallback&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    actionArgs = massageArgsJsToNative(actionArgs);</div><div class="line"></div><div class="line">    <span class="keyword">var</span> command = [callbackId, service, action, actionArgs];</div><div class="line"></div><div class="line">    <span class="comment">// Stringify and queue the command. We stringify to command now to</span></div><div class="line">    <span class="comment">// effectively clone the command arguments in case they are mutated before</span></div><div class="line">    <span class="comment">// the command is executed.</span></div><div class="line">    <span class="comment">// 全局数组存放序列化参数</span></div><div class="line">    commandQueue.push(<span class="built_in">JSON</span>.stringify(command));</div><div class="line"></div><div class="line">    <span class="comment">// If we're in the context of a stringByEvaluatingJavaScriptFromString call,</span></div><div class="line">    <span class="comment">// then the queue will be flushed when it returns; no need for a poke.</span></div><div class="line">    <span class="comment">// Also, if there is already a command in the queue, then we've already</span></div><div class="line">    <span class="comment">// poked the native side, so there is no reason to do so again.</span></div><div class="line">    <span class="keyword">if</span> (!isInContextOfEvalJs &amp;&amp; commandQueue.length == <span class="number">1</span>) &#123;</div><div class="line">        <span class="comment">// 与oc通信方法</span></div><div class="line">        pokeNative();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>old version中使用XMLHttpRequest发送请求任务，最新version使用iframe.contentWindow.localtion发送请求，并与native约定URL为gap://ready。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">pokeNative</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// CB-5488 - Don't attempt to create iframe before document.body is available.</span></div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">document</span>.body) &#123;</div><div class="line">        setTimeout(pokeNative);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Check if they've removed it from the DOM, and put it back if so.</span></div><div class="line">    <span class="keyword">if</span> (execIframe &amp;&amp; execIframe.contentWindow) &#123;</div><div class="line">        execIframe.contentWindow.location = <span class="string">'gap://ready'</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        execIframe = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</div><div class="line">        execIframe.style.display = <span class="string">'none'</span>;</div><div class="line">        execIframe.src = <span class="string">'gap://ready'</span>;</div><div class="line">        <span class="built_in">document</span>.body.appendChild(execIframe);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Use a timer to protect against iframe being unloaded during the poke (CB-7735).</span></div><div class="line">    <span class="comment">// This makes the bridge ~ 7% slower, but works around the poke getting lost</span></div><div class="line">    <span class="comment">// when the iframe is removed from the DOM.</span></div><div class="line">    <span class="comment">// An onunload listener could be used in the case where the iframe has just been</span></div><div class="line">    <span class="comment">// created, but since unload events fire only once, it doesn't work in the normal</span></div><div class="line">    <span class="comment">// case of iframe reuse (where unload will have already fired due to the attempted</span></div><div class="line">    <span class="comment">// navigation of the page).</span></div><div class="line">    failSafeTimerId = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (commandQueue.length) &#123;</div><div class="line">            <span class="comment">// CB-10106 - flush the queue on bridge change</span></div><div class="line">            <span class="keyword">if</span> (!handleBridgeChange()) &#123;</div><div class="line">                pokeNative();</div><div class="line">             &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;, <span class="number">50</span>); <span class="comment">// Making this &gt; 0 improves performance (marginally) in the normal case (where it doesn't fire).</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/apache/cordova-ios/tree/master/CordovaLib/Classes" target="_blank" rel="external">cordova_ios</a></p>
<ul>
<li>项目初始化<br>在<strong>CDVViewController</strong>中初始化<strong>CDVCommandQueue</strong>，<strong>CDVConfigParser</strong></li>
<li><strong>CDVCommandQueue</strong>中<strong>fetchCommandsFromJs</strong>拦截js请求，并解析js参数，<strong>CDVInvokedUrlCommand</strong>类定义了参数model</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)fetchCommandsFromJs</div><div class="line">&#123;</div><div class="line">    __<span class="keyword">weak</span> CDVCommandQueue* weakSelf = <span class="keyword">self</span>;</div><div class="line">    <span class="built_in">NSString</span>* js = <span class="string">@"cordova.require('cordova/exec').nativeFetchMessages()"</span>;</div><div class="line">    <span class="comment">// 封装stringByEvaluatingJavaScriptFromString::方法，native调用js方法</span></div><div class="line">    [_viewController.webViewEngine evaluateJavaScript:js</div><div class="line">                                    completionHandler:^(<span class="keyword">id</span> obj, <span class="built_in">NSError</span>* error) &#123;</div><div class="line">        <span class="keyword">if</span> ((error == <span class="literal">nil</span>) &amp;&amp; [obj isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">            <span class="built_in">NSString</span>* queuedCommandsJSON = (<span class="built_in">NSString</span>*)obj;</div><div class="line">            CDV_EXEC_LOG(<span class="string">@"Exec: Flushed JS-&gt;native queue (hadCommands=%d)."</span>, [queuedCommandsJSON length] &gt; <span class="number">0</span>);</div><div class="line">            [weakSelf enqueueCommandBatch:queuedCommandsJSON];</div><div class="line">            <span class="comment">// this has to be called here now, because fetchCommandsFromJs is now async (previously: synchronous)</span></div><div class="line">            [<span class="keyword">self</span> executePending];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><strong>CDVConfigParser</strong>读取解析config.xml中配置信息，将plugin信息保存到pluginsDict属性中，在<strong>CDVViewController</strong>中注册插件</li>
<li>自定义插件，传入callbackID</li>
<li>实现协议CDVCommandDelegate中sendPluginResult::方法，将plugin result返回js</li>
</ul>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)sendPluginResult:(CDVPluginResult*)result callbackId:(<span class="built_in">NSString</span>*)callbackId</div><div class="line">&#123;</div><div class="line">    CDV_EXEC_LOG(<span class="string">@"Exec(%@): Sending result. Status=%@"</span>, callbackId, result.status);</div><div class="line">    <span class="comment">// This occurs when there is are no win/fail callbacks for the call.</span></div><div class="line">    <span class="keyword">if</span> ([<span class="string">@"INVALID"</span> isEqualToString:callbackId]) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// This occurs when the callback id is malformed.</span></div><div class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> isValidCallbackId:callbackId]) &#123;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Invalid callback id received by sendPluginResult"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> status = [result.status intValue];</div><div class="line">    <span class="built_in">BOOL</span> keepCallback = [result.keepCallback boolValue];</div><div class="line">    <span class="built_in">NSString</span>* argumentsAsJSON = [result argumentsAsJSON];</div><div class="line">    <span class="built_in">BOOL</span> debug = <span class="literal">NO</span>;</div><div class="line">    </div><div class="line"><span class="meta">#ifdef DEBUG</span></div><div class="line">    debug = <span class="literal">YES</span>;</div><div class="line"><span class="meta">#endif</span></div><div class="line"></div><div class="line">    <span class="built_in">NSString</span>* js = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"cordova.require('cordova/exec').nativeCallback('%@',%d,%@,%d, %d)"</span>, callbackId, status, argumentsAsJSON, keepCallback, debug];</div><div class="line">    <span class="comment">// 封装了webView方法stringByEvaluatingJavaScriptFromString::</span></div><div class="line">    [<span class="keyword">self</span> evalJsHelper:js];</div><div class="line">&#125;</div></pre></td></tr></table></figure>

  </div>
</article>
    </main>
    <footer class='footer'>
	<span>© 2016-2018</span>
	<a href='https://hexo.io/zh-cn/'>hexo</a>
</footer>

<script src="/js/highlight.js"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-112017168-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments)}
    gtag('js', new Date());
    gtag('config', 'UA-112017168-1');
</script>
<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "https://hm.baidu.com/hm.js?79947b6af0dc16bd0e5cab5df00cde71";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
</script>
  </body>
</html>